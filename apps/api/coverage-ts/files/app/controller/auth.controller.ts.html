
  <!DOCTYPE html>
  <html>
    <head>
      <title>auth.controller.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="..\..\..\assets\source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="..\..\..\assets\source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="..\..\..\index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">app\controller\auth.controller.ts</td><td class="">93.99%</td><td class="">80%</td><td class="">449</td><td class="">422</td><td class="">27</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import { Request, Response } from &#x27;express&#x27;;
import authService from &#x27;../service/auth/auth&#x27;;
import google from &#x27;../service/auth/google&#x27;;
import { user as User } from &#x27;../models/index&#x27;;
import ServerError from &#x27;../helpers/errors/server.error&#x27;;
import emailService from &#x27;../utils/send-email&#x27;;
import checkParams from &#x27;../utils/check-params&#x27;;
import NotFoundError from &#x27;../helpers/errors/not-found.error&#x27;;
import tokenHandler from &#x27;../helpers/token.handler&#x27;;
import AuthorizationError from &#x27;../helpers/errors/unauthorized.error&#x27;;
import { CLIENT_URL } from &#x27;../utils/variables&#x27;;
import bcrypt from &#x27;bcrypt&#x27;;
import APITypeError from &#x27;../helpers/errors/type.error&#x27;;
import ForbidenError from &#x27;../helpers/errors/forbiden&#x27;;
import { UserInfosToken } from &#x27;skillcoop-types&#x27;;

export default {
  async register(req: Request, res: Response) {
    const { email, password } = req.body;
    let newUser: { id: number; email: string };

    try {
      const shouldCreateNewUser = await authService.createUser({
        email,
        password,
      });
      if (shouldCreateNewUser) {
        newUser = shouldCreateNewUser;
      } else throw new ServerError(&#x27;Failed create user&#x27;);
    } catch (error) {
      return res.status(400).send(&#x27;Infos not valid&#x27;);
    }

    const emailToken = tokenHandler.createToken(
      &#x27;1h&#x27;,
      process.env.JWT_EMAIL_TOKEN_KEY as string,
      {
        user_id: newUser.id,
      },
    );
    await emailService.sendEmailToConfirmEmail({
      emailToken,
      email,
      userId: newUser.id,
    });

    return res.status(200).json({
      message:
        &#x27;A link to activate your account has been sent to provided email&#x27;,
    });
  },
  async signin(req: Request, res: Response) {
    const { email, password } = req.body;
    const MAX_AGE = 1000 * 60 * 60 * 24 * 7; // 7 days

    const { accessToken, refreshToken } = await authService.login({
      email,
      password,
    });
    // production cookie
    res.cookie(&#x27;refreshToken&#x27;, refreshToken, {
      httpOnly: true,
      sameSite: &#x27;none&#x27;,
      secure: true,
      maxAge: MAX_AGE,
    });
    res.status(200).json({ accessToken });
  },
  async refresh(req: Request, res: Response) {
    const { decoded } = req.body;
    const user = await User.findByPk(decoded.user_id);
    if (!user) {
      res.clearCookie(&#x27;refreshToken&#x27;, { sameSite: &#x27;none&#x27;, secure: true });
      throw new AuthorizationError(&#x27;Unauthorized&#x27;);
    }
    const accessToken = tokenHandler.createToken(
      &#x27;15m&#x27;,
      process.env.JWT_TOKEN_KEY as string,
      decoded,
    );

    res.status(200).json({ accessToken });
  },
  async logout(_req: Request, res: Response) {
    res.clearCookie(&#x27;refreshToken&#x27;, { sameSite: &#x27;none&#x27;, secure: true });

    // NEED TO SEND SOMETHING WITH STATUS IF NOT COOKIE IS NOT CLEAR
    res.status(204).end();
  },
  async googleAuth(req: Request, res: Response) {
    const { code } = req.query;
    if (typeof code !== &#x27;string&#x27;)
      throw new APITypeError(
        &#x27;Code provided is not a string&#x27;,
        &#x27;googleAuth&#x27;,
        &#x27; 93&#x27;,
      );

    const { access_token: googleToken, id_token } = await google.getOAuthToken({
      code,
    });
    if (!googleToken || !id_token)
      throw new ServerError(&#x27;Error getting token from google &#x27;);

    const { email, given_name, family_name, picture } = await google.getUser({
      access_token: googleToken,
      id_token,
    });

    if (!email)
      throw new ServerError(
        &#x27;Could not get email from google&#x27;,
        &#x27;googleAuth&#x27;,
        &#x27;105&#x27;,
      );
    const [user] = await User.findBy({ email });

    let userInfos;
    if (!user) {
      userInfos = await authService.createGoogleUser({
        email,
        given_name,
        family_name,
        picture,
      });
    } else {
      // TODO think about to automaticly update profile with google information
      userInfos = { user_id: user.id, email: user.email };
    }
    const { accessToken, refreshToken } =
      tokenHandler.createPairAuthToken(userInfos);

    res.cookie(&#x27;refreshToken&#x27;, refreshToken, {
      httpOnly: true,
      sameSite: &#x27;none&#x27;,
      secure: true,
      maxAge: 24 * 60 * 60 * 1000,
    });
    res
      .status(301)
      .redirect(`${CLIENT_URL}/auth/google/?access_token=${accessToken}`);
  },
  async verifyEmail(req: Request, res: Response) {
    const { token } = req.params;
    const [userId] = checkParams(req.params.userId);

    const userInfos = tokenHandler.verifyTokenAndGetData(
      token,
      process.env.JWT_EMAIL_TOKEN_KEY as string,
    );
    if (userInfos &amp;&amp; userId !== (userInfos as UserInfosToken).user_id)
      //eslint-disable-line
      throw new ServerError(&#x27;User id is not matching&#x27;, &#x27;verifyEmail&#x27;, &#x27; 136&#x27;);

    const verifiedUser = await User.update(userId, { verified: 1 });
    if (!verifiedUser)
      throw new ServerError(&quot;Couldn&#x27;t verify user&quot;, &#x27;verifyEmail&#x27;, &#x27; 144&#x27;);

    res.status(300).redirect(`${CLIENT_URL}/login`);
  },
  async resendEmail(req: Request, res: Response) {
    const { email } = req.body;
    const [user] = await User.findBy({ email });

    if (!user)
      throw new NotFoundError(
        &quot;Couldn&#x27;t find user with email provided in database&quot;,
        &#x27;resendEmail&#x27;,
        &#x27; 152&#x27;,
      );
    const emailToken = tokenHandler.createToken(
      &#x27;1h&#x27;,
      process.env.JWT_EMAIL_TOKEN_KEY as string,
      {
        user_id: user.id,
      },
    );

    const url = `${process.env.API_URL}/auth/${user.id}/verify/${emailToken}`;
    const text = `Click on the link to verify your email: ${url}`;
    await emailService.sendVerify(email, &#x27;validate your email&#x27;, text);

    return res
      .status(200)
      .json({ message: &#x27;A new confirmation email has been sent&#x27; });
  },
  async forgotPassword(req: Request, res: Response) {
    const { email } = req.body;
    const [user] = await User.findBy({ email });
    if (user &amp;&amp; user.verified === 0) {
      throw new ForbidenError(
        &#x27;User accound not verified&#x27;,
        &#x27;Not allowed&#x27;,
        &#x27;forgotPassword&#x27;,
        &#x27; 169&#x27;,
      );
    }

    if (user &amp;&amp; user.verified === 1) {
      const resetPasswordToken = tokenHandler.createToken(
        &#x27;10m&#x27;,
        process.env.JWT_EMAIL_TOKEN_KEY as string,
        {
          user_id: user.id,
        },
      );
      await emailService.sendLinkRestPassword({
        resetToken: resetPasswordToken,
        email: email,
        userId: user.id,
      });
    }

    res.status(200).json({
      message: &#x27;If you have a valid account an email has been sent&#x27;,
    });
  },
  async redirectToResetPassword(req: Request, res: Response) {
    const { token } = req.params;
    const [userId] = checkParams(req.params.userId);
    try {
      const userInfos = tokenHandler.verifyTokenAndGetData(
        token,
        process.env.JWT_EMAIL_TOKEN_KEY as string,
      );
      if (userInfos &amp;&amp; userId !== userInfos.user_id) {
        throw new ServerError(
          &#x27;User id is not matching&#x27;,
          &#x27;redirectToResetPassword&#x27;,
          &#x27; 193&#x27;,
        );
      }
    } catch (error) {
      return res.redirect(`${CLIENT_URL}/`);
    }

    res.cookie(&#x27;_rset&#x27;, token, {
      httpOnly: true,
      sameSite: &#x27;none&#x27;,
      secure: true,
      domain: process.env.DOMAIN,
      maxAge: 10 * 60 * 1000,
    });
    res.status(301).redirect(`${CLIENT_URL}/reset-password`);
  },
  async verifyResetPasswordToken(req: Request, res: Response) {
    const token = req.cookies._rset;
    try {
      const infos = tokenHandler.verifyTokenAndGetData(
        token,
        process.env.JWT_EMAIL_TOKEN_KEY as string,
      );

      if (infos &amp;&amp; !infos.user_id) {
        return res.status(200).json({ message: &#x27;expire&#x27; });
      }
      res.status(200).json({ message: &#x27;success&#x27; });
    } catch (error) {
      return res.status(200).json({ message: &#x27;expire&#x27; });
    }
  },
  async resetPassword(req: Request, res: Response) {
    const { password } = req.body;
    const saltRouds = 10;
    const hashedPassword = await bcrypt
      .hash(password, saltRouds)
      .catch((err) =&gt; {
        if (err)
          throw new ServerError(
            &quot;Couldn&#x27;t hash user password&quot;,
            &#x27;resetPassword&#x27;,
            &#x27; 231&#x27;,
          );
      });
    // ??? why ???
    if (!hashedPassword) throw new ServerError(&#x27;hash password is missing&#x27;);

    const token = req.cookies._rset;
    try {
      const infos = tokenHandler.verifyTokenAndGetData(
        token,
        process.env.JWT_EMAIL_TOKEN_KEY as string,
      );
      if (!infos || !infos.user_id)
        return res.status(200).json({ message: &#x27;expire&#x27; });
      if (infos &amp;&amp; infos.user_id) {
        await User.update(+infos.user_id, { password: hashedPassword });
        res.status(200).json({ message: &#x27;success&#x27; });
      }
    } catch (error) {
      return res.status(200).json({ message: &#x27;expire&#x27; });
    }
  },
};
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:18,&quot;character&quot;:12,&quot;text&quot;:&quot;email&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:18,&quot;character&quot;:19,&quot;text&quot;:&quot;password&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:18,&quot;character&quot;:36,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:52,&quot;character&quot;:12,&quot;text&quot;:&quot;email&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:52,&quot;character&quot;:19,&quot;text&quot;:&quot;password&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:52,&quot;character&quot;:36,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:69,&quot;character&quot;:12,&quot;text&quot;:&quot;decoded&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:69,&quot;character&quot;:28,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:70,&quot;character&quot;:37,&quot;text&quot;:&quot;decoded&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:70,&quot;character&quot;:45,&quot;text&quot;:&quot;user_id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:117,&quot;character&quot;:8,&quot;text&quot;:&quot;userInfos&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:119,&quot;character&quot;:6,&quot;text&quot;:&quot;userInfos&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:127,&quot;character&quot;:6,&quot;text&quot;:&quot;userInfos&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:161,&quot;character&quot;:12,&quot;text&quot;:&quot;email&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:161,&quot;character&quot;:26,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:187,&quot;character&quot;:12,&quot;text&quot;:&quot;email&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:187,&quot;character&quot;:26,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:246,&quot;character&quot;:10,&quot;text&quot;:&quot;token&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:246,&quot;character&quot;:22,&quot;text&quot;:&quot;cookies&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:246,&quot;character&quot;:30,&quot;text&quot;:&quot;_rset&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:262,&quot;character&quot;:12,&quot;text&quot;:&quot;password&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:262,&quot;character&quot;:29,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:266,&quot;character&quot;:14,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:267,&quot;character&quot;:12,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:277,&quot;character&quot;:10,&quot;text&quot;:&quot;token&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:277,&quot;character&quot;:22,&quot;text&quot;:&quot;cookies&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;app\\controller\\auth.controller.ts&quot;,&quot;line&quot;:277,&quot;character&quot;:30,&quot;text&quot;:&quot;_rset&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 04 Jan 2024 18:32:37 GMT</p>
    </body>
  </html>
  