
  <!DOCTYPE html>
  <html>
    <head>
      <title>compute-data.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="..\..\..\..\assets\source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="..\..\..\..\assets\source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="..\..\..\..\index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">app\service\compute-rating\compute-data.ts</td><td class="">100.00%</td><td class="">80%</td><td class="">196</td><td class="">196</td><td class="">0</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import { AvgSkill, Score, Skills } from &#x27;skillcoop-types&#x27;;
import { UserEvaluationsBonus } from &#x27;./sql-methods&#x27;;
import computeGbRating from &#x27;../../utils/compute-gb-rating&#x27;;

type ArgsSkillCompute = {
  ownEval: number;
  receivedEval: number;
  nbReceivedEval: number;
  nbBonus: number;
};

export class ComputeRating {
  WEIGHT_OWN_EVAL = 7;
  VALUE_BONUS = 100;
  skillNames = [&#x27;pace&#x27;, &#x27;defending&#x27;, &#x27;passing&#x27;, &#x27;dribbling&#x27;, &#x27;shooting&#x27;];

  ownEval?: Skills;
  receivedEval?: AvgSkill;
  nbEvalReceived: number;
  nb_mvp: number;
  nb_best_striker: number;
  profileId: number;

  constructor(
    userEvaluationsAndBonus: UserEvaluationsBonus,
    profileId: number,
  ) {
    this.profileId = profileId;
    this.ownEval = userEvaluationsAndBonus.user_own_evaluation;
    this.receivedEval = userEvaluationsAndBonus.avg_evaluation_received;
    this.nbEvalReceived = this.receivedEval
      ? this.receivedEval.nb_eval_received
      : 0;
    this.nb_mvp = userEvaluationsAndBonus.nb_mvp;
    this.nb_best_striker = userEvaluationsAndBonus.nb_best_striker;
  }
  compute() {
    const avgSkills = this.constructAvgSkills();
    const gbRating = this.getRatingWithBonus(avgSkills);
    return {
      ...avgSkills,
      gb_rating: gbRating,
      profileId: this.profileId,
    };
  }
  getRatingWithBonus(avgSkills: Score) {
    const globalRatingBeforeMvPBonus = computeGbRating(avgSkills);
    const gbRating = this.applyMvpBonus(globalRatingBeforeMvPBonus);
    return gbRating;
  }
  applyMvpBonus(rating: number) {
    const userHaveEvaluateHimself = this.ownEval ? this.WEIGHT_OWN_EVAL : 0;
    const totalEvals = userHaveEvaluateHimself + this.nbEvalReceived;
    const gbRatingMvpApplied =
      (rating * totalEvals + this.nb_mvp * this.VALUE_BONUS) /
      (totalEvals + this.nb_mvp);

    return Math.floor(gbRatingMvpApplied);
  }
  computeAvgSkillValue(skill: Partial&lt;Skills&gt; | string) {
    const args = {
      ownEval: this.ownEval ? this.ownEval[`${skill}` as keyof Skills] : 0,
      receivedEval: this.receivedEval
        ? this.receivedEval[`${skill}` as keyof Skills]
        : 0,
      nbReceivedEval: this.nbEvalReceived,
      nbBonus: 0,
    };
    if (skill === &#x27;shooting&#x27;) {
      args.nbBonus = this.nb_best_striker;
    }
    return Math.floor(this.getNumerator(args) / this.getDenominator(args));
  }
  constructAvgSkills(): Score {
    return this.skillNames.reduce((acc, currSkillName) =&gt; {
      const skillName = `avg_${currSkillName}`;
      return {
        ...acc,
        [skillName]: this.computeAvgSkillValue(currSkillName),
      };
    }, {}) as Score;
  }
  getNumerator(args: ArgsSkillCompute) {
    return (
      this.productNumerator(args.ownEval, this.WEIGHT_OWN_EVAL) +
      this.productNumerator(args.receivedEval, args.nbReceivedEval) +
      this.productNumerator(this.VALUE_BONUS, args.nbBonus)
    );
  }
  productNumerator(value: number | undefined, coef: number = 1) {
    if (!value || !coef) return 0;
    return value * coef;
  }
  getDenominator(args: ArgsSkillCompute) {
    const ownEvalDenominator = args.ownEval ? this.WEIGHT_OWN_EVAL : 0;
    const receivedDenominator = args.receivedEval ? args.nbReceivedEval : 0;
    return ownEvalDenominator + receivedDenominator + args.nbBonus;
  }
}
</textarea><pre id="annotations" style="display:none">[]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 04 Jan 2024 18:32:37 GMT</p>
    </body>
  </html>
  